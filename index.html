<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ã‚¤ãƒ™ãƒ³ãƒˆå†™çœŸæŠ•ç¨¿</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body { height: 100%; }
  body { margin: 0; font-family: "Inter", "Hiragino Kaku Gothic ProN", sans-serif; }
  #map { height: 100vh; width: 100vw; }
  .map-center-indicator {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 26px;
    height: 26px;
    margin-left: -13px;
    margin-top: -13px;
    border-radius: 50%;
    border: 3px solid #ff3860;
    background: rgba(255, 255, 255, 0.5);
    box-shadow: 0 0 0 2px rgba(255, 56, 96, 0.2);
    z-index: 900;
    pointer-events: none;
  }
  .map-center-indicator::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 6px;
    height: 6px;
    margin-left: -3px;
    margin-top: -3px;
    border-radius: 50%;
    background: #ff3860;
  }
  .corner-button {
    position: fixed;
    width: 60px;
    height: 60px;
    border-radius: 999px;
    z-index: 1100;
  }
  .corner-button--top-right {
    top: 24px;
    right: 24px;
  }
  .corner-button--bottom-right {
    right: 24px;
    bottom: 24px;
  }
  .corner-button--bottom-left {
    bottom: 24px;
    left: 24px;
  }
  .corner-button--top-left {
    left: 24px;
    top: 24px;
  }
  .photo-popup {
    width: 220px;
  }
  .photo-popup img {
    width: 100%;
    border-radius: 12px;
    margin-bottom: 8px;
  }
  .photo-popup .tag {
    margin-bottom: 6px;
  }
  .modal {
    z-index: 2000;
  }
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
  }
  .gallery-item {
    background: #fff;
    border-radius: 12px;
    padding: 8px;
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
  }
  .gallery-item img {
    width: 100%;
    border-radius: 8px;
    display: block;
  }
  .gallery-item .tag {
    margin-top: 6px;
  }
</style>
</head>

<body>

<div id="map"></div>
<div class="map-center-indicator" aria-hidden="true"></div>

<button id="manualButton" class="button is-warning is-rounded corner-button corner-button--top-right" aria-label="ãƒãƒ‹ãƒ¥ã‚¢ãƒ«">
  â”
</button>
<button id="galleryButton" class="button is-info is-rounded corner-button corner-button--bottom-right" aria-label="å†™çœŸä¸€è¦§">
  ğŸ–¼ï¸
</button>
<button id="openModal" class="button is-primary is-rounded corner-button corner-button--bottom-left" aria-label="ç™»éŒ²">
  ï¼‹
</button>
<button id="recenterButton" class="button is-link is-rounded corner-button corner-button--top-left" aria-label="ç¾åœ¨åœ°ã¸æˆ»ã‚‹">
  ğŸ“
</button>

<div id="registerModal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">å†™çœŸã‚’ç™»éŒ²</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div class="field">
        <label class="label">ã‚¿ã‚°</label>
        <div class="control">
          <input
            class="input"
            id="tag"
            list="tagOptions"
            placeholder="ã‚¿ã‚°ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›"
            required
          >
          <datalist id="tagOptions"></datalist>
        </div>
      </div>

      <div class="field">
        <label class="label">å†™çœŸ</label>
        <div class="file is-boxed is-fullwidth">
          <label class="file-label">
            <input class="file-input" type="file" id="photo" accept="image/*">
            <span class="file-cta">
              <span class="file-icon">ğŸ“¸</span>
              <span class="file-label">å†™çœŸã‚’é¸ã¶</span>
            </span>
          </label>
        </div>
      </div>

      <div class="field">
        <label class="label">ã²ã¨ã“ã¨ï¼ˆä»»æ„ï¼‰</label>
        <div class="control">
          <textarea class="textarea" id="comment" placeholder="æ’®å½±ã—ãŸæ§˜å­ã‚’ãƒ¡ãƒ¢ã—ã¾ã—ã‚‡ã†"></textarea>
        </div>
      </div>
      <p class="help">ç™»éŒ²åœ°ç‚¹ã¯ <strong>åœ°å›³ã®ä¸­å¿ƒ</strong> ã«ãªã‚Šã¾ã™ã€‚</p>
    </section>
    <footer class="modal-card-foot">
      <button id="submitPhoto" class="button is-primary is-fullwidth">ç™»éŒ²ã™ã‚‹</button>
      <p id="submitStatus" class="help is-info is-hidden">ç™»éŒ²ä¸­...</p>
    </footer>
  </div>
</div>

<div id="manualModal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div class="content">
        <ol>
          <li>åœ°å›³ã‚’å‹•ã‹ã—ã¦ã€ç™»éŒ²ã—ãŸã„å ´æ‰€ã‚’ <strong>ä¸­å¿ƒ</strong> ã«åˆã‚ã›ã¾ã™ã€‚</li>
          <li>ã€Œï¼‹ã€ãƒœã‚¿ãƒ³ã§å†™çœŸç™»éŒ²ç”»é¢ã‚’é–‹ãã¾ã™ã€‚</li>
          <li>ã‚¿ã‚°ã¨å†™çœŸã‚’é¸ã³ã€ã€Œç™»éŒ²ã™ã‚‹ã€ã‚’æŠ¼ã—ã¾ã™ã€‚</li>
        </ol>
        <p class="is-size-7 has-text-grey">ç¾åœ¨åœ°ã«æˆ»ã‚‹ã«ã¯ã€ŒğŸ“ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    </section>
  </div>
</div>

<div id="galleryModal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">å†™çœŸä¸€è¦§</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div id="galleryGrid" class="gallery-grid"></div>
      <p id="galleryEmpty" class="help is-hidden">å†™çœŸãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
    </section>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzfEU5jaZYQw_ApnknegqjsfOTff2WPMag3BD2fJhHSMQrOAngaDOSaFiwb_GNoQiM_/exec";

let lat, lng;
let isSubmitting = false;
let currentLocationMarker;
let cachedPhotos = [];

const modal = document.getElementById("registerModal");
const openModalButton = document.getElementById("openModal");
const closeModalButton = modal.querySelector(".delete");
const modalBackground = modal.querySelector(".modal-background");
const submitButton = document.getElementById("submitPhoto");
const submitStatus = document.getElementById("submitStatus");
const tagInput = document.getElementById("tag");
const tagOptions = document.getElementById("tagOptions");
const photoInput = document.getElementById("photo");
const commentInput = document.getElementById("comment");
const recenterButton = document.getElementById("recenterButton");
const manualButton = document.getElementById("manualButton");
const galleryButton = document.getElementById("galleryButton");
const manualModal = document.getElementById("manualModal");
const galleryModal = document.getElementById("galleryModal");
const galleryGrid = document.getElementById("galleryGrid");
const galleryEmpty = document.getElementById("galleryEmpty");

const openModal = () => {
  modal.classList.add("is-active");
};

const closeModal = () => {
  modal.classList.remove("is-active");
};

const openManualModal = () => {
  manualModal.classList.add("is-active");
};

const closeManualModal = () => {
  manualModal.classList.remove("is-active");
};

const openGalleryModal = () => {
  renderGallery(cachedPhotos);
  galleryModal.classList.add("is-active");
};

const closeGalleryModal = () => {
  galleryModal.classList.remove("is-active");
};

openModalButton.addEventListener("click", openModal);
closeModalButton.addEventListener("click", closeModal);
modalBackground.addEventListener("click", closeModal);
manualButton.addEventListener("click", openManualModal);
galleryButton.addEventListener("click", openGalleryModal);

manualModal.querySelector(".delete").addEventListener("click", closeManualModal);
manualModal.querySelector(".modal-background").addEventListener("click", closeManualModal);
galleryModal.querySelector(".delete").addEventListener("click", closeGalleryModal);
galleryModal.querySelector(".modal-background").addEventListener("click", closeGalleryModal);

// åœ°å›³
const map = L.map('map').setView([0, 0], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap'
}).addTo(map);

const setCurrentLocation = (position) => {
  lat = position.coords.latitude;
  lng = position.coords.longitude;
  map.setView([lat, lng], 17);
  if (currentLocationMarker) {
    currentLocationMarker.setLatLng([lat, lng]);
  } else {
    currentLocationMarker = L.marker([lat, lng])
      .addTo(map)
      .bindPopup("ä»Šã„ã‚‹å ´æ‰€", { autoPan: false });
  }
};

const requestCurrentLocation = () => {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      setCurrentLocation(pos);
    },
    () => {
      if (typeof lat === "number" && typeof lng === "number") {
        map.setView([lat, lng], 17);
        return;
      }
      alert("ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä½ç½®æƒ…å ±ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  );
};

// ç¾åœ¨åœ°
requestCurrentLocation();

recenterButton.addEventListener("click", requestCurrentLocation);

const buildDriveImageUrl = (fileId) => (
  fileId ? `https://drive.google.com/thumbnail?id=${fileId}&sz=w800` : ""
);

const extractDriveFileId = (url) => {
  if (!url) {
    return "";
  }

  const match = url.match(/\/d\/([-\w]{25,})/);
  if (match) {
    return match[1];
  }

  const queryMatch = url.match(/[?&]id=([-\w]{25,})/);
  if (queryMatch) {
    return queryMatch[1];
  }

  return "";
};

const getDriveImageUrl = (photo) => {
  const explicitId = photo.fileId || "";
  if (explicitId) {
    return buildDriveImageUrl(explicitId);
  }

  const extractedId = extractDriveFileId(photo.imageUrl);
  if (extractedId) {
    return buildDriveImageUrl(extractedId);
  }

  return photo.imageUrl || "";
};

const renderExistingPhotos = (photos) => {
  if (!Array.isArray(photos)) {
    return;
  }

  cachedPhotos = photos;
  photos.forEach(photo => {
    if (typeof photo.lat !== "number" || typeof photo.lng !== "number") {
      return;
    }

    const imageUrl = getDriveImageUrl(photo);
    const popupHtml = `
      <div class="photo-popup">
        ${imageUrl ? `<img src="${imageUrl}" alt="${photo.tag || "æŠ•ç¨¿å†™çœŸ"}">` : ""}
        ${photo.tag ? `<span class="tag is-info is-light">${photo.tag}</span>` : ""}
        ${photo.comment ? `<p class="is-size-7">${photo.comment}</p>` : ""}
      </div>
    `;

    L.marker([photo.lat, photo.lng])
      .addTo(map)
      .bindPopup(popupHtml);
  });
};

const renderGallery = (photos) => {
  galleryGrid.innerHTML = "";
  const validPhotos = Array.isArray(photos) ? photos.filter(photo => photo.imageUrl || photo.fileId) : [];
  galleryEmpty.classList.toggle("is-hidden", validPhotos.length > 0);

  validPhotos.forEach(photo => {
    const imageUrl = getDriveImageUrl(photo);
    const item = document.createElement("div");
    item.className = "gallery-item";
    item.innerHTML = `
      ${imageUrl ? `<img src="${imageUrl}" alt="${photo.tag || "å†™çœŸ"}">` : ""}
      ${photo.tag ? `<span class="tag is-info is-light">${photo.tag}</span>` : ""}
      ${photo.comment ? `<p class="is-size-7">${photo.comment}</p>` : ""}
    `;
    item.addEventListener("click", () => {
      if (typeof photo.lat === "number" && typeof photo.lng === "number") {
        map.setView([photo.lat, photo.lng], 17);
        closeGalleryModal();
      }
    });
    galleryGrid.appendChild(item);
  });
};

const loadExistingPhotos = () => {
  const callbackName = `photoMapCallback_${Date.now()}`;
  window[callbackName] = (data) => {
    renderExistingPhotos(data ? data.photos : []);
    delete window[callbackName];
    script.remove();
  };

  const script = document.createElement("script");
  script.src = `${GAS_URL}?mode=list&callback=${callbackName}`;
  script.onerror = () => {
    console.warn("ç™»éŒ²æ¸ˆã¿å†™çœŸã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
    delete window[callbackName];
    script.remove();
  };
  document.body.appendChild(script);
};

loadExistingPhotos();

const renderTagOptions = (tags) => {
  tagOptions.innerHTML = "";
  if (!Array.isArray(tags)) {
    return;
  }

  tags.forEach(tag => {
    const option = document.createElement("option");
    option.value = tag;
    tagOptions.appendChild(option);
  });
};

const loadTagOptions = () => {
  const callbackName = `tagOptionsCallback_${Date.now()}`;
  window[callbackName] = (data) => {
    renderTagOptions(data ? data.tags : []);
    delete window[callbackName];
    script.remove();
  };

  const script = document.createElement("script");
  script.src = `${GAS_URL}?mode=tags&callback=${callbackName}`;
  script.onerror = () => {
    console.warn("ã‚¿ã‚°ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
    delete window[callbackName];
    script.remove();
  };
  document.body.appendChild(script);
};

loadTagOptions();

const setSubmittingState = (submitting) => {
  isSubmitting = submitting;
  submitButton.disabled = submitting;
  submitButton.classList.toggle("is-loading", submitting);
  submitStatus.classList.toggle("is-hidden", !submitting);
  tagInput.disabled = submitting;
  photoInput.disabled = submitting;
  commentInput.disabled = submitting;
  openModalButton.disabled = submitting;
  closeModalButton.disabled = submitting;
  recenterButton.disabled = submitting;
  manualButton.disabled = submitting;
  galleryButton.disabled = submitting;
};

// é€ä¿¡
function send() {
  if (isSubmitting) {
    return;
  }

  const file = document.getElementById("photo").files[0];
  const tag = document.getElementById("tag").value;
  const center = map.getCenter();

  if (!file || !tag) {
    alert("å†™çœŸã¨ã‚¿ã‚°ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  const reader = new FileReader();
  reader.onload = async () => {
    const payload = new URLSearchParams({
      lat: center.lat,
      lng: center.lng,
      tag,
      comment: document.getElementById("comment").value,
      image: reader.result.split(",")[1]
    });

    setSubmittingState(true);

    const timeoutId = setTimeout(() => {
      if (isSubmitting) {
        setSubmittingState(false);
        alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    }, 15000);

    try {
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors",
        body: payload
      });

      clearTimeout(timeoutId);
      setSubmittingState(false);

      alert("é€ä¿¡ã—ã¾ã—ãŸï¼");
      location.reload();
    } catch (error) {
      clearTimeout(timeoutId);
      setSubmittingState(false);
      alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
  };
  reader.readAsDataURL(file);
}

submitButton.addEventListener("click", send);
</script>

</body>
</html>
