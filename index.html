<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>イベント写真投稿</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="favicon.png" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
  integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body { height: 100%; }
  body { margin: 0; font-family: "Inter", "Hiragino Kaku Gothic ProN", sans-serif; }
  #map { height: 100vh; width: 100vw; }
  .map-center-indicator {
    position: fixed;
    top: 50%;
    left: 50%;
    width: 26px;
    height: 26px;
    margin-left: -13px;
    margin-top: -13px;
    border-radius: 50%;
    border: 3px solid #ff3860;
    background: rgba(255, 255, 255, 0.5);
    box-shadow: 0 0 0 2px rgba(255, 56, 96, 0.2);
    z-index: 900;
    pointer-events: none;
  }
  .map-center-indicator::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 6px;
    height: 6px;
    margin-left: -3px;
    margin-top: -3px;
    border-radius: 50%;
    background: #ff3860;
  }
  .corner-button {
    position: fixed;
    width: 60px;
    height: 60px;
    border-radius: 999px;
    z-index: 1100;
    border: 0;
    color: #fff;
    box-shadow: 0 10px 24px rgba(15, 23, 42, 0.24);
    transition: transform 0.15s ease, box-shadow 0.15s ease, filter 0.15s ease;
  }
  .corner-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 12px 26px rgba(15, 23, 42, 0.3);
    filter: brightness(1.04);
  }
  .corner-button:focus-visible {
    outline: 3px solid rgba(255, 255, 255, 0.95);
    outline-offset: 2px;
  }
  .corner-button--manual {
    background: linear-gradient(135deg, #8b5cf6, #6d28d9);
  }
  .corner-button--gallery {
    background: linear-gradient(135deg, #0891b2, #0e7490);
  }
  .corner-button--register {
    background: linear-gradient(135deg, #f97316, #ea580c);
  }
  .corner-button--recenter {
    background: linear-gradient(135deg, #16a34a, #15803d);
  }
  .corner-button--top-right {
    top: 24px;
    right: 24px;
  }
  .corner-button--bottom-right {
    right: 24px;
    bottom: 24px;
  }
  .corner-button--bottom-left {
    bottom: 24px;
    left: 24px;
  }
  .corner-button--top-left {
    left: 24px;
    top: 24px;
  }
  .photo-popup {
    width: 220px;
  }
  .photo-popup img {
    width: 100%;
    border-radius: 12px;
    margin-bottom: 8px;
  }
  .photo-popup .tag {
    margin-bottom: 6px;
  }
  .modal {
    z-index: 2000;
  }
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
  }
  .gallery-item {
    background: #fff;
    border-radius: 12px;
    padding: 8px;
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
  }
  .gallery-item img {
    width: 100%;
    border-radius: 8px;
    display: block;
  }
  .gallery-item .tag {
    margin-top: 6px;
  }
  .photo-file .file-cta {
    background-color: #3e8ed0;
    border-color: #3e8ed0;
    color: #fff;
  }
  .photo-file .file-cta:hover {
    background-color: #3486c9;
    border-color: #3486c9;
  }
  .photo-file .file-name {
    background-color: #f5f7ff;
    border-color: #c3d4f6;
    color: #1f2a44;
  }
</style>
</head>

<body>

<div id="map"></div>
<div class="map-center-indicator" aria-hidden="true"></div>

<button id="manualButton" class="button is-rounded corner-button corner-button--manual corner-button--top-right" aria-label="マニュアル">
  <i class="fa-solid fa-question"></i>
</button>
<button id="galleryButton" class="button is-rounded corner-button corner-button--gallery corner-button--bottom-right" aria-label="写真一覧">
  <i class="fa-solid fa-image"></i>
</button>
<button id="openModal" class="button is-rounded corner-button corner-button--register corner-button--bottom-left" aria-label="登録">
  <i class="fa-solid fa-camera"></i>
</button>
<button id="recenterButton" class="button is-rounded corner-button corner-button--recenter corner-button--top-left" aria-label="現在地へ戻る">
  <i class="fa-solid fa-arrows-to-dot"></i>
</button>

<div id="registerModal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">写真を登録</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div class="form-grid">
        <div class="field">
          <label class="label" for="tagSelect">タグ</label>
          <div class="control mb-2">
            <div class="select is-fullwidth">
              <select id="tagSelect" aria-label="候補タグから選択">
                <option value="">候補から選択（任意）</option>
              </select>
            </div>
          </div>
          <div class="control">
            <input
              class="input"
              id="tag"
              placeholder="タグを入力（例: 受付、会場、ステージ）"
              autocomplete="off"
              required
            >
          </div>
          <p class="help">候補を選ぶか、自由に入力できます。</p>
        </div>

        <div class="field">
          <label class="label">写真</label>
          <div class="file has-name is-fullwidth photo-file">
            <label class="file-label">
              <input class="file-input" type="file" id="photo" accept="image/*">
              <span class="file-cta">
                <span class="file-icon">
                  <i class="fas fa-upload"></i>
                </span>
                <span class="file-label">写真を選ぶ</span>
              </span>
              <span class="file-name" id="photoName">未選択</span>
            </label>
          </div>
        </div>

        <div class="field is-full">
          <label class="label">ひとこと（任意）</label>
          <div class="control">
            <textarea class="textarea" id="comment" placeholder="撮影した様子をメモしましょう"></textarea>
          </div>
        </div>
      </div>
      <p class="help">登録地点は <strong>地図の中心</strong> になります。</p>
    </section>
    <footer class="modal-card-foot">
      <button id="submitPhoto" class="button is-primary is-fullwidth">登録する</button>
      <p id="submitStatus" class="help is-info is-hidden">登録中...</p>
    </footer>
  </div>
</div>

<div id="manualModal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">マニュアル</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div class="content">
        <ol>
          <li>地図を動かして、登録したい場所を <strong>中心</strong> に合わせます。</li>
          <li>「<i class="fa-solid fa-camera"></i>」ボタンで写真登録画面を開きます。</li>
          <li>タグと写真を選び、「登録する」を押します。</li>
        </ol>
        <p class="is-size-7 has-text-grey">現在地に戻るには「<i class="fa-solid fa-arrows-to-dot"></i>」ボタンを押してください。</p>
      </div>
    </section>
  </div>
</div>

<div id="galleryModal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">写真一覧</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div id="galleryGrid" class="gallery-grid"></div>
      <p id="galleryEmpty" class="help is-hidden">写真がまだ登録されていません。</p>
    </section>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzfEU5jaZYQw_ApnknegqjsfOTff2WPMag3BD2fJhHSMQrOAngaDOSaFiwb_GNoQiM_/exec";

let lat, lng;
let isSubmitting = false;
let currentLocationMarker;
let cachedPhotos = [];

const modal = document.getElementById("registerModal");
const openModalButton = document.getElementById("openModal");
const closeModalButton = modal.querySelector(".delete");
const modalBackground = modal.querySelector(".modal-background");
const submitButton = document.getElementById("submitPhoto");
const submitStatus = document.getElementById("submitStatus");
const tagInput = document.getElementById("tag");
const tagSelect = document.getElementById("tagSelect");
const photoInput = document.getElementById("photo");
const photoName = document.getElementById("photoName");
const commentInput = document.getElementById("comment");
const recenterButton = document.getElementById("recenterButton");
const manualButton = document.getElementById("manualButton");
const galleryButton = document.getElementById("galleryButton");
const manualModal = document.getElementById("manualModal");
const galleryModal = document.getElementById("galleryModal");
const galleryGrid = document.getElementById("galleryGrid");
const galleryEmpty = document.getElementById("galleryEmpty");

const openModal = () => {
  modal.classList.add("is-active");
};

const closeModal = () => {
  modal.classList.remove("is-active");
};

const openManualModal = () => {
  manualModal.classList.add("is-active");
};

const closeManualModal = () => {
  manualModal.classList.remove("is-active");
};

const openGalleryModal = () => {
  renderGallery(cachedPhotos);
  galleryModal.classList.add("is-active");
};

const closeGalleryModal = () => {
  galleryModal.classList.remove("is-active");
};

openModalButton.addEventListener("click", openModal);
closeModalButton.addEventListener("click", closeModal);
modalBackground.addEventListener("click", closeModal);
manualButton.addEventListener("click", openManualModal);
galleryButton.addEventListener("click", openGalleryModal);

tagSelect.addEventListener("change", () => {
  if (!tagSelect.value) {
    return;
  }
  tagInput.value = tagSelect.value;
  tagInput.focus();
});

tagInput.addEventListener("input", () => {
  if (tagSelect.value && tagInput.value.trim() !== tagSelect.value) {
    tagSelect.value = "";
  }
});

photoInput.addEventListener("change", () => {
  const file = photoInput.files && photoInput.files[0];
  photoName.textContent = file ? file.name : "未選択";
});

manualModal.querySelector(".delete").addEventListener("click", closeManualModal);
manualModal.querySelector(".modal-background").addEventListener("click", closeManualModal);
galleryModal.querySelector(".delete").addEventListener("click", closeGalleryModal);
galleryModal.querySelector(".modal-background").addEventListener("click", closeGalleryModal);

// 地図
const map = L.map('map', { zoomControl: false }).setView([0, 0], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

const setCurrentLocation = (position) => {
  lat = position.coords.latitude;
  lng = position.coords.longitude;
  map.setView([lat, lng], 17);
  if (currentLocationMarker) {
    currentLocationMarker.setLatLng([lat, lng]);
  } else {
    currentLocationMarker = L.marker([lat, lng])
      .addTo(map)
      .bindPopup("今いる場所", { autoPan: false });
  }
};

const requestCurrentLocation = () => {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      setCurrentLocation(pos);
    },
    () => {
      if (typeof lat === "number" && typeof lng === "number") {
        map.setView([lat, lng], 17);
        return;
      }
      alert("現在地の取得に失敗しました。位置情報の許可を確認してください。");
    }
  );
};

// 現在地
requestCurrentLocation();

recenterButton.addEventListener("click", requestCurrentLocation);

const buildDriveImageUrl = (fileId) => (
  fileId ? `https://drive.google.com/thumbnail?id=${fileId}&sz=w800` : ""
);

const extractDriveFileId = (url) => {
  if (!url) {
    return "";
  }

  const match = url.match(/\/d\/([-\w]{25,})/);
  if (match) {
    return match[1];
  }

  const queryMatch = url.match(/[?&]id=([-\w]{25,})/);
  if (queryMatch) {
    return queryMatch[1];
  }

  return "";
};

const getDriveImageUrl = (photo) => {
  const explicitId = photo.fileId || "";
  if (explicitId) {
    return buildDriveImageUrl(explicitId);
  }

  const extractedId = extractDriveFileId(photo.imageUrl);
  if (extractedId) {
    return buildDriveImageUrl(extractedId);
  }

  return photo.imageUrl || "";
};

const renderExistingPhotos = (photos) => {
  if (!Array.isArray(photos)) {
    return;
  }

  cachedPhotos = photos;
  photos.forEach(photo => {
    if (typeof photo.lat !== "number" || typeof photo.lng !== "number") {
      return;
    }

    const imageUrl = getDriveImageUrl(photo);
    const popupHtml = `
      <div class="photo-popup">
        ${imageUrl ? `<img src="${imageUrl}" alt="${photo.tag || "投稿写真"}">` : ""}
        ${photo.tag ? `<span class="tag is-info is-light">${photo.tag}</span>` : ""}
        ${photo.comment ? `<p class="is-size-7">${photo.comment}</p>` : ""}
      </div>
    `;

    L.marker([photo.lat, photo.lng])
      .addTo(map)
      .bindPopup(popupHtml);
  });
};

const renderGallery = (photos) => {
  galleryGrid.innerHTML = "";
  const validPhotos = Array.isArray(photos) ? photos.filter(photo => photo.imageUrl || photo.fileId) : [];
  galleryEmpty.classList.toggle("is-hidden", validPhotos.length > 0);

  validPhotos.forEach(photo => {
    const imageUrl = getDriveImageUrl(photo);
    const item = document.createElement("div");
    item.className = "gallery-item";
    item.innerHTML = `
      ${imageUrl ? `<img src="${imageUrl}" alt="${photo.tag || "写真"}">` : ""}
      ${photo.tag ? `<span class="tag is-info is-light">${photo.tag}</span>` : ""}
      ${photo.comment ? `<p class="is-size-7">${photo.comment}</p>` : ""}
    `;
    item.addEventListener("click", () => {
      if (typeof photo.lat === "number" && typeof photo.lng === "number") {
        map.setView([photo.lat, photo.lng], 17);
        closeGalleryModal();
      }
    });
    galleryGrid.appendChild(item);
  });
};

const loadExistingPhotos = () => {
  const callbackName = `photoMapCallback_${Date.now()}`;
  window[callbackName] = (data) => {
    renderExistingPhotos(data ? data.photos : []);
    delete window[callbackName];
    script.remove();
  };

  const script = document.createElement("script");
  script.src = `${GAS_URL}?mode=list&callback=${callbackName}`;
  script.onerror = () => {
    console.warn("登録済み写真の取得に失敗しました");
    delete window[callbackName];
    script.remove();
  };
  document.body.appendChild(script);
};

loadExistingPhotos();

const renderTagOptions = (tags) => {
  tagSelect.innerHTML = "";

  const placeholderOption = document.createElement("option");
  placeholderOption.value = "";
  placeholderOption.textContent = "候補から選択（任意）";
  tagSelect.appendChild(placeholderOption);

  if (!Array.isArray(tags)) {
    return;
  }

  tags.forEach(tag => {
    const option = document.createElement("option");
    option.value = tag;
    option.textContent = tag;
    tagSelect.appendChild(option);
  });
};

const loadTagOptions = () => {
  const callbackName = `tagOptionsCallback_${Date.now()}`;
  window[callbackName] = (data) => {
    renderTagOptions(data ? data.tags : []);
    delete window[callbackName];
    script.remove();
  };

  const script = document.createElement("script");
  script.src = `${GAS_URL}?mode=tags&callback=${callbackName}`;
  script.onerror = () => {
    console.warn("タグ一覧の取得に失敗しました");
    delete window[callbackName];
    script.remove();
  };
  document.body.appendChild(script);
};

loadTagOptions();

const setSubmittingState = (submitting) => {
  isSubmitting = submitting;
  submitButton.disabled = submitting;
  submitButton.classList.toggle("is-loading", submitting);
  submitStatus.classList.toggle("is-hidden", !submitting);
  tagInput.disabled = submitting;
  tagSelect.disabled = submitting;
  photoInput.disabled = submitting;
  commentInput.disabled = submitting;
  openModalButton.disabled = submitting;
  closeModalButton.disabled = submitting;
  recenterButton.disabled = submitting;
  manualButton.disabled = submitting;
  galleryButton.disabled = submitting;
};

// 送信
function send() {
  if (isSubmitting) {
    return;
  }

  const file = document.getElementById("photo").files[0];
  const tag = document.getElementById("tag").value.trim();
  const center = map.getCenter();

  if (!file || !tag) {
    alert("写真とタグを選択してください");
    return;
  }

  const reader = new FileReader();
  reader.onload = async () => {
    const payload = new URLSearchParams({
      lat: center.lat,
      lng: center.lng,
      tag,
      comment: document.getElementById("comment").value,
      image: reader.result.split(",")[1]
    });

    setSubmittingState(true);

    const timeoutId = setTimeout(() => {
      if (isSubmitting) {
        setSubmittingState(false);
        alert("送信に失敗しました。通信状態を確認してください。");
      }
    }, 15000);

    try {
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors",
        body: payload
      });

      clearTimeout(timeoutId);
      setSubmittingState(false);

      alert("送信しました！");
      location.reload();
    } catch (error) {
      clearTimeout(timeoutId);
      setSubmittingState(false);
      alert("送信に失敗しました。通信状態を確認してください。");
    }
  };
  reader.readAsDataURL(file);
}

submitButton.addEventListener("click", send);
</script>

</body>
</html>
