<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>イベント写真投稿</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body { height: 100%; }
  body { margin: 0; font-family: "Inter", "Hiragino Kaku Gothic ProN", sans-serif; }
  #map { height: 100vh; width: 100vw; }
  .fab {
    position: fixed;
    right: 24px;
    bottom: 24px;
    border-radius: 999px;
    width: 64px;
    height: 64px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 14px 30px rgba(0, 0, 0, 0.25);
    font-size: 28px;
    z-index: 1000;
  }
  .photo-popup {
    width: 220px;
  }
  .photo-popup img {
    width: 100%;
    border-radius: 12px;
    margin-bottom: 8px;
  }
  .photo-popup .tag {
    margin-bottom: 6px;
  }
  .modal-card {
    width: min(92vw, 480px);
  }
  .modal-card-body {
    background: #f8fafc;
  }
</style>
</head>

<body>

<div id="map"></div>

<button id="openModal" class="button is-primary fab" aria-label="登録">
  ＋
</button>

<div id="registerModal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">写真を登録</p>
      <button class="delete" aria-label="close"></button>
    </header>
    <section class="modal-card-body">
      <div class="field">
        <label class="label">タグ</label>
        <div class="control">
          <div class="select is-fullwidth">
            <select id="tag" required>
              <option value="">タグを選択</option>
              <option value="会場">会場</option>
              <option value="ステージ">ステージ</option>
              <option value="展示">展示</option>
              <option value="飲食">飲食</option>
              <option value="物販">物販</option>
              <option value="休憩">休憩</option>
              <option value="その他">その他</option>
            </select>
          </div>
        </div>
      </div>

      <div class="field">
        <label class="label">写真</label>
        <div class="control">
          <input class="input" type="file" id="photo" accept="image/*">
        </div>
      </div>

      <div class="field">
        <label class="label">ひとこと（任意）</label>
        <div class="control">
          <textarea class="textarea" id="comment" placeholder="撮影した様子をメモしましょう"></textarea>
        </div>
      </div>
    </section>
    <footer class="modal-card-foot">
      <button id="submitPhoto" class="button is-primary is-fullwidth">登録する</button>
    </footer>
  </div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzfEU5jaZYQw_ApnknegqjsfOTff2WPMag3BD2fJhHSMQrOAngaDOSaFiwb_GNoQiM_/exec";

let lat, lng;
let isSubmitting = false;

const modal = document.getElementById("registerModal");
const openModalButton = document.getElementById("openModal");
const closeModalButton = modal.querySelector(".delete");
const modalBackground = modal.querySelector(".modal-background");
const submitButton = document.getElementById("submitPhoto");

const openModal = () => {
  modal.classList.add("is-active");
};

const closeModal = () => {
  modal.classList.remove("is-active");
};

openModalButton.addEventListener("click", openModal);
closeModalButton.addEventListener("click", closeModal);
modalBackground.addEventListener("click", closeModal);

// 地図
const map = L.map('map').setView([0, 0], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

// 現在地
navigator.geolocation.getCurrentPosition(pos => {
  lat = pos.coords.latitude;
  lng = pos.coords.longitude;
  map.setView([lat, lng], 17);
  L.marker([lat, lng]).addTo(map).bindPopup("今いる場所").openPopup();
});

const getDriveImageUrl = (photo) => {
  if (photo.fileId) {
    return `https://drive.google.com/uc?export=view&id=${photo.fileId}`;
  }

  if (!photo.imageUrl) {
    return "";
  }

  const match = photo.imageUrl.match(/[-\w]{25,}/);
  if (match) {
    return `https://drive.google.com/uc?export=view&id=${match[0]}`;
  }
  return photo.imageUrl;
};

const renderExistingPhotos = (photos) => {
  if (!Array.isArray(photos)) {
    return;
  }

  photos.forEach(photo => {
    if (typeof photo.lat !== "number" || typeof photo.lng !== "number") {
      return;
    }

    const imageUrl = getDriveImageUrl(photo);
    const popupHtml = `
      <div class="photo-popup">
        ${imageUrl ? `<img src="${imageUrl}" alt="${photo.tag || "投稿写真"}">` : ""}
        ${photo.tag ? `<span class="tag is-info is-light">${photo.tag}</span>` : ""}
        ${photo.comment ? `<p class="is-size-7">${photo.comment}</p>` : ""}
      </div>
    `;

    L.marker([photo.lat, photo.lng])
      .addTo(map)
      .bindPopup(popupHtml);
  });
};

const loadExistingPhotos = () => {
  const callbackName = `photoMapCallback_${Date.now()}`;
  window[callbackName] = (data) => {
    renderExistingPhotos(data ? data.photos : []);
    delete window[callbackName];
    script.remove();
  };

  const script = document.createElement("script");
  script.src = `${GAS_URL}?mode=list&callback=${callbackName}`;
  script.onerror = () => {
    console.warn("登録済み写真の取得に失敗しました");
    delete window[callbackName];
    script.remove();
  };
  document.body.appendChild(script);
};

loadExistingPhotos();

// 送信
function send() {
  const file = document.getElementById("photo").files[0];
  const tag = document.getElementById("tag").value;

  if (!file || !tag) {
    alert("写真とタグを選択してください");
    return;
  }

  const reader = new FileReader();
  reader.onload = async () => {
    const payload = new URLSearchParams({
      lat,
      lng,
      tag,
      comment: document.getElementById("comment").value,
      image: reader.result.split(",")[1]
    });

    isSubmitting = true;

    const timeoutId = setTimeout(() => {
      if (isSubmitting) {
        isSubmitting = false;
        alert("送信に失敗しました。通信状態を確認してください。");
      }
    }, 15000);

    try {
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors",
        body: payload
      });

      clearTimeout(timeoutId);
      isSubmitting = false;

      alert("送信しました！");
      location.reload();
    } catch (error) {
      clearTimeout(timeoutId);
      isSubmitting = false;
      alert("送信に失敗しました。通信状態を確認してください。");
    }
  };
  reader.readAsDataURL(file);
}

submitButton.addEventListener("click", send);
</script>

</body>
</html>
